<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompts MeDo X</title>
    <link rel="icon" href="icon.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-light: #f8f9fa; --surface-light: #ffffff; --text-light: #212529; --text-secondary-light: #6c757d; --primary-light: #0d6efd; --primary-hover-light: #0b5ed7; --success-light: #198754; --danger-light: #dc3545; --border-light: #dee2e6; --input-bg-light: #f1f3f5;
            --bg-dark: #121212; --surface-dark: #1e1e1e; --text-dark: #e9ecef; --text-secondary-dark: #adb5bd; --primary-dark: #4dabf7; --primary-hover-dark: #74c0fc; --success-dark: #20c997; --danger-dark: #ff6b6b; --border-dark: #343a40; --input-bg-dark: #2c2f33;
            --bg-color: var(--bg-light); --surface-color: var(--surface-light); --text-color: var(--text-light); --text-secondary-color: var(--text-secondary-light); --primary-color: var(--primary-light); --primary-hover-color: var(--primary-hover-light); --success-color: var(--success-light); --danger-color: var(--danger-light); --border-color: var(--border-light); --input-bg-color: var(--input-bg-light);
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.08); --font-family: 'Tajawal', sans-serif; --border-radius: 20px;
        }
        .dark-mode {
            --bg-color: var(--bg-dark); --surface-color: var(--surface-dark); --text-color: var(--text-dark); --text-secondary-color: var(--text-secondary-dark); --primary-color: var(--primary-dark); --primary-hover-color: var(--primary-hover-dark); --success-color: var(--success-dark); --danger-color: var(--danger-dark); --border-color: var(--border-dark); --input-bg-color: var(--input-bg-dark);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); line-height: 1.7; user-select: none; }
        .container { max-width: 1100px; margin: 0 auto; padding: 2rem 1.5rem; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem; }
        header h1 { font-size: 2.2rem; font-weight: 800; color: var(--primary-color); }
        .header-actions { display: flex; gap: 0.75rem; align-items: center; }
        .card { background-color: var(--surface-color); padding: 2rem; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 2.5rem; }
        textarea, input, select, .scene-content, .preview-content, #outputContent, .json-output { user-select: text; }
        textarea { width: 100%; min-height: 140px; padding: 1.2rem; border-radius: 12px; border: 2px solid var(--border-color); background-color: var(--input-bg-color); color: var(--text-color); font-family: var(--font-family); font-size: 1.1rem; resize: vertical; transition: all 0.2s ease; }
        textarea:focus { outline: none; border-color: var(--primary-color); }
        .input-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; margin-top: 1.5rem; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; margin-top: 1.5rem; align-items: flex-start; }
        .input-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .input-group label { font-weight: 700; opacity: 0.9; font-size: 0.9rem; }
        .input-group input { width: 100%; padding: 0.8rem; border-radius: 12px; border: 2px solid var(--border-color); background-color: var(--input-bg-color); color: var(--text-color); font-size: 1rem; }
        .input-group input:focus { outline: none; border-color: var(--primary-color); }
        .custom-select { position: relative; width: 100%; font-size: 1rem; }
        .select-trigger { display: flex; align-items: center; justify-content: space-between; padding: 0.8rem; border-radius: 12px; border: 2px solid var(--border-color); background-color: var(--input-bg-color); cursor: pointer; transition: all 0.2s ease; }
        .custom-select.open .select-trigger { border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--primary-color-a, rgba(13, 110, 253, 0.25));}
        .dark-mode .custom-select.open .select-trigger { box-shadow: 0 0 0 3px var(--primary-color-a, rgba(77, 171, 247, 0.25));}
        .select-trigger .arrow { width: 12px; height: 12px; border-left: 2px solid currentColor; border-bottom: 2px solid currentColor; transform: rotate(-45deg); transition: transform 0.2s ease; }
        .custom-select.open .arrow { transform: rotate(135deg); }
        .options { position: absolute; top: 110%; left: 0; right: 0; background-color: var(--surface-color); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: var(--shadow); z-index: 10; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.2s ease; max-height: 200px; overflow-y: auto;}
        .custom-select.open .options { opacity: 1; visibility: visible; transform: translateY(0); }
        .option-item { padding: 0.8rem 1rem; cursor: pointer; }
        .option-item:hover { background-color: var(--input-bg-color); }
        .option-item.selected { background-color: var(--primary-color); color: white; }
        .segmented-control { display: flex; flex-wrap: wrap; background-color: var(--input-bg-color); border-radius: 12px; padding: 4px; }
        .sg-btn { flex: 1; text-align: center; padding: 0.7rem; border: none; background: transparent; color: var(--text-secondary-color); font-size: 1rem; font-weight: 700; cursor: pointer; border-radius: 8px; transition: all 0.3s ease; }
        .sg-btn.active { color: var(--text-color); background-color: var(--surface-color); box-shadow: 0 1px 3px rgba(0,0,0,0.1);}
        .helper-text { font-size: 0.8rem; color: var(--text-secondary-color); text-align: center; margin-top: 0.5rem; min-height: 1.2em; }
        .main-controls { display: flex; flex-wrap: wrap; justify-content: flex-end; align-items: center; gap: 1rem; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color); }
        .action-btn { position:relative; background: var(--input-bg-color); border: none; color: var(--text-color); min-width: 44px; height: 44px; border-radius: 12px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 1rem; font-weight: 700; padding: 0 1.2rem; transition: all 0.2s ease; }
        .action-btn:disabled { cursor: not-allowed; opacity: 0.6; }
        .action-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .primary-btn { background: var(--primary-color); color: white; }
        .primary-btn:hover:not(:disabled) { background: var(--primary-hover-color); }
        .secondary-btn { background-color: var(--surface-color); border: 2px solid var(--border-color); }
        .toolbar-btn { font-size: 1.2rem; padding: 0; }
        .action-btn i { font-size: 1.1em; }
        .action-btn span { margin-right: 0.5rem; }
        .output-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .output-header h3 { font-size: 1.8rem; font-weight: 700; }
        #outputTabs { display: flex; flex-wrap: wrap; gap: 0.5rem; border-bottom: 2px solid var(--border-color); margin-bottom: 1.5rem; }
        .tab-btn { padding: 0.75rem 1.5rem; border: none; background-color: transparent; cursor: pointer; font-size: 1rem; font-weight: 700; color: var(--text-secondary-color); position: relative; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .output-panel { display: none; animation: fadeIn 0.5s ease; }
        .output-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: var(--surface-color); border-radius: var(--border-radius); padding: 2rem; width: 90%; max-width: 700px; max-height: 80vh; display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .preview-content, #outputContent { flex-grow: 1; overflow-y: auto; background-color: var(--input-bg-color); padding: 1rem; border-radius: 12px; }
        .preview-content::-webkit-scrollbar, #outputContent::-webkit-scrollbar { width: 8px; }
        .preview-content::-webkit-scrollbar-thumb, #outputContent::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        .modal-footer { flex-shrink: 0; display: flex; justify-content: flex-end; gap: 1rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); margin-top: 1.5rem; }
        .projects-list { list-style: none; padding: 0; }
        .project-item { display: grid; grid-template-columns: 1fr auto; align-items: center; padding: 1rem; border-radius: 12px; margin-bottom: 1rem; background: var(--input-bg-color); cursor: pointer; transition: all 0.2s ease; }
        .project-item:hover { transform: scale(1.02); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .placeholder { width: 100%; display: flex; justify-content: center; align-items: center; min-height: 300px; color: var(--text-secondary-color); font-size: 1.2rem; background-color: var(--input-bg-color); border-radius: var(--border-radius); }
        #toast-notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150%); color: var(--text-color); padding: 1rem 1.5rem; border-radius: 12px; box-shadow: var(--shadow); display: flex; align-items: center; gap: 1rem; z-index: 1001; transition: all 0.4s ease-in-out; background-color: var(--surface-color); border-left: 5px solid var(--primary-color);}
        #toast-notification.success { border-left-color: var(--success-color); }
        #toast-notification.error { border-left-color: var(--danger-color); }
        #toast-notification.visible { transform: translateX(-50%) translateY(0); }
        .spinner { display: flex; align-items: center; justify-content: center; }
        .spinner .dot { width: 8px; height: 8px; margin: 0 3px; background-color: currentColor; border-radius: 50%; animation: wave 1.4s infinite ease-in-out both; }
        .spinner .dot:nth-child(1) { animation-delay: -0.32s; }
        .spinner .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes wave { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .json-output { white-space: pre; font-family: monospace; font-size: 0.9rem; direction: ltr; text-align: left; overflow-x: auto; }
        .json-output::-webkit-scrollbar { height: 8px; }
        .json-output::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        .json-key { color: var(--danger-color); }
        .json-string { color: var(--success-color); }
        .json-number { color: var(--primary-color); }
        .json-boolean, .json-null { color: #6f42c1; }
        .dark-mode .json-boolean, .dark-mode .json-null { color: #c39ac9; }
        footer { text-align: center; margin-top: 3rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); color: var(--text-secondary-color); font-size: 0.9rem; }
    </style>
</head>
<body>
    <div id="projects-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2>المشاريع المحفوظة</h2><button class="toolbar-btn action-btn" data-action="close-modal" data-target="projects-modal"><i class="fa-solid fa-xmark"></i></button></div><ul id="projects-list" class="projects-list"></ul></div></div>
    <div id="preview-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2 id="preview-title">معاينة المشروع</h2><button class="toolbar-btn action-btn" data-action="close-modal" data-target="preview-modal"><i class="fa-solid fa-xmark"></i></button></div><div id="preview-content" class="preview-content"></div><div class="modal-footer"><div id="preview-toolbar" class="header-actions"></div><button id="load-from-preview-btn" class="action-btn primary-btn">تحميل للمحرر</button></div></div></div>
    <div id="confirm-dialog" class="modal-overlay"><div class="modal-content" style="max-width: 400px;"><div class="modal-header"><h2>تأكيد</h2></div><p>حقل الإدخال فارغ. هل تريد المتابعة وإنشاء محتوى عشوائي إبداعي؟</p><div class="modal-footer"><button id="confirm-dialog-no" class="action-btn secondary-btn">لا</button><button id="confirm-dialog-yes" class="action-btn primary-btn">نعم، أنشئ</button></div></div></div>
    <div id="toast-notification"><div id="toast-spinner" class="spinner"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div><span id="toast-message"></span></div>

    <div class="container">
        <header><h1>Prompts MeDo X</h1><div class="header-actions"><button class="action-btn" id="my-projects-btn" title="المشاريع المحفوظة"><i class="fa-solid fa-folder-open"></i></button><button class="action-btn" id="themeToggleBtn" title="تغيير الثيم"><i class="fa-solid fa-moon"></i></button></div></header>
        <div class="card">
            <div id="output-options" class="segmented-control" style="margin-bottom: 1.5rem;">
                <button class="sg-btn active" data-type="short_script">سكربت قصير</button>
                <button class="sg-btn" data-type="veo_prompt">برومبت Veo3</button>
                <button class="sg-btn" data-type="youtube_script">سكربت يوتيوب</button>
                <button class="sg-btn" data-type="chatbot_prompt">برومبت Chatbot</button>
            </div>
            <div class="input-header"><label for="userInput" style="font-weight: 700; opacity: 0.9; font-size: 1.1rem;">فكرتك الأساسية</label><button class="action-btn" id="inspiration-btn" title="إلهام"><i class="fa-solid fa-wand-magic-sparkles"></i> <span>إلهام</span></button></div>
            <textarea id="userInput" placeholder="اكتب فكرتك هنا أو اضغط على زر الإلهام..."></textarea>
            <div class="input-grid">
                <div class="input-group">
                    <label>اختر الموديل</label>
                    <div class="segmented-control" id="model-selector">
                        <button class="sg-btn active" data-model="gemini-2.5-pro">Pro</button>
                        <button class="sg-btn" data-model="gemini-2.5-flash">Flash</button>
                    </div>
                    <p id="model-helper-text" class="helper-text">الأقوى والأكثر إبداعًا، قد يكون أبطأ قليلاً.</p>
                </div>
               <div class="input-group">
    <label>اللهجة</label>
    <div class="custom-select" id="dialect-selector">
        <div class="select-trigger">
            <span>مصرية</span>
            <div class="arrow"></div>
        </div>
        <div class="options">
            <div class="option-item selected" data-value="egyptian">مصرية</div>
            <div class="option-item" data-value="saudi">سعودية</div>
            <div class="option-item" data-value="lebanese">لبنانية</div>
            <div class="option-item" data-value="khaleeji">خليجية</div>
            <div class="option-item" data-value="fusha">فصحى</div>
            <div class="option-item" data-value="other">أخرى...</div>
        </div>
    </div>

                    <input type="text" id="custom-dialect-input" placeholder="اكتب لهجتك هنا..." style="display: none; margin-top: 0.5rem;">
                </div>
                <div class="input-group">
                    <label>نبرة الكتابة</label>
                    <div class="custom-select" id="tone-of-voice"><div class="select-trigger"><span>إبداعية</span><div class="arrow"></div></div><div class="options"><div class="option-item selected" data-value="إبداعية">إبداعية</div><div class="option-item" data-value="رسمية">رسمية</div><div class="option-item" data-value="تسويقية">تسويقية</div><div class="option-item" data-value="تعليمية">تعليمية</div><div class="option-item" data-value="مرحة">مرحة</div></div></div>
                </div>
                 <div class="input-group" data-controls-for="chatbot_prompt">
                    <label>اختر دور للـ AI</label>
                    <div class="custom-select" id="chatbot-role"><div class="select-trigger"><span>مساعد عام</span><div class="arrow"></div></div><div class="options"><div class="option-item selected" data-value="مساعد عام">مساعد عام</div><div class="option-item" data-value="خبير تسويق">خبير تسويق</div><div class="option-item" data-value="كاتب سيناريو">كاتب سيناريو</div><div class="option-item" data-value="مطور برامج">مطور برامج</div><div class="option-item" data-value="مدرب شخصي">مدرب شخصي</div></div></div>
                </div>
                <div class="input-group" data-controls-for="short_script veo_prompt">
                    <label for="director-style">البصمة الإخراجية (اختياري)</label>
                    <input type="text" id="director-style" placeholder="مثال: بأسلوب سينمائي قديم">
                </div>
                <div class="input-group" data-controls-for="veo_prompt">
                    <label for="sceneCount">عدد المشاهد (للبرومبت)</label>
                    <input type="number" id="sceneCount" value="3" min="1" max="10">
                </div>
                <div class="input-group" data-controls-for="youtube_script">
                    <label for="videoDuration">مدة الفيديو (بالدقائق)</label>
                    <input type="number" id="videoDuration" value="5" min="1" max="60">
                </div>
            </div>
            <div class="main-controls"><button id="generateAllBtn" class="action-btn secondary-btn"><span>إنشاء الكل</span></button><button id="generateBtn" class="action-btn primary-btn"><span>أنشئ الآن</span></button></div>
        </div>
        <div class="card">
            <div id="output-container" style="display: none;"><div class="output-header"><h3>التحفة النهائية</h3><div id="main-toolbar" class="header-actions"></div></div><div id="outputTabs"></div><div id="outputContent"></div></div>
            <div id="placeholder" class="placeholder">الاستوديو الإبداعي في انتظار أوامرك...</div>
        </div>
        <footer><p>جميع الحقوق محفوظة Mohamed Ayman - MeDoAnDrOiD 2025</p></footer>
    </div>

    <script>
    try {
        document.addEventListener('DOMContentLoaded', function() {
            const API_KEY = 'AIzaSyAL-BevRKG83YT2IcPt4qEU7vy7BXKT4uc';
            const PROJECTS_STORAGE_KEY = 'MeDoX_Projects_Masterpiece';
            let currentOutputFormat = 'short_script';
            let lastGeneratedData = {};
            let isGenerating = false;
            let selectedModel = 'gemini-2.5-flash';
            const apiCache = new Map();

            const $ = (selector) => document.querySelector(selector);
            
            const showToast = (message, type = 'info', isLoading = false) => {
                const toast = $('#toast-notification');
                if(!toast) return;
                $('#toast-message').textContent = message;
                toast.className = 'toast';
                if (type !== 'info') toast.classList.add(type);
                $('#toast-spinner').style.display = isLoading ? 'flex' : 'none';
                toast.classList.add('visible');
                if (!isLoading) {
                    setTimeout(() => toast.classList.remove('visible'), 3500);
                }
            };

            const toggleModal = (modalId, show) => {
                const modal = $(`#${modalId}`);
                if (modal) modal.classList.toggle('visible', show);
            };

            const toggleButtonLoading = (btn, isLoading) => {
                if (!btn) return;
                const btnText = btn.querySelector('span');
                btn.disabled = isLoading;
                const spinner = btn.querySelector('.spinner');
                if (isLoading) {
                    if (btnText) btnText.style.visibility = 'hidden';
                    if (!spinner) {
                        const newSpinner = document.createElement('div');
                        newSpinner.className = 'spinner';
                        newSpinner.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
                        btn.appendChild(newSpinner);
                    }
                } else {
                    if (btnText) btnText.style.visibility = 'visible';
                    if (spinner) spinner.remove();
                }
            };
            
            const copyToClipboard = (text, btn) => {
                if (!text || !navigator.clipboard) return;
                navigator.clipboard.writeText(text).then(() => {
                    const originalIcon = btn.innerHTML;
                    btn.innerHTML = '<i class="fa-solid fa-check"></i>';
                    setTimeout(() => { btn.innerHTML = originalIcon; }, 2000);
                });
            };

            const downloadContent = (content, filename) => {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = filename;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
            
            const highlightJSON = (jsonString) => {
                if (typeof jsonString != 'string') {
                    jsonString = JSON.stringify(jsonString, undefined, 2);
                }
                jsonString = jsonString.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return jsonString.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                    let cls = 'json-number';
                    if (/^"/.test(match)) { cls = /:$/.test(match) ? 'json-key' : 'json-string'; } 
                    else if (/true|false/.test(match)) { cls = 'json-boolean'; } 
                    else if (/null/.test(match)) { cls = 'json-null'; }
                    return '<span class="' + cls + '">' + match + '</span>';
                });
            };

            const performGeneration = async (prompt) => {
                if (!navigator.onLine) {
                    showToast('لا يوجد اتصال بالإنترنت. يرجى التحقق من الشبكة.', 'error');
                    return null;
                }
                const cacheKey = JSON.stringify({prompt, model: selectedModel});
                if (apiCache.has(cacheKey) && prompt.format !== 'inspiration') return apiCache.get(cacheKey);
                
                isGenerating = true;
                let generatedText = null;
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${API_KEY}`;
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || 'Unknown API Error');
                    }
                    const data = await response.json();
                    if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                        generatedText = data.candidates[0].content.parts[0].text;
                        if(prompt.format !== 'inspiration') apiCache.set(cacheKey, generatedText);
                    } else { throw new Error('No content returned from API.'); }
                } catch (error) {
                    showToast(`خطأ: ${error.message}`, 'error');
                } finally {
                    isGenerating = false;
                }
                return generatedText;
            };
            
            const buildMasterPrompt = ({ idea, format, sceneCount, directorStyle, duration, tone, dialect, chatbotRole, script }) => {
                const loglineInstruction = `\n\nFinally, at the very end of your entire response, add a short summary under a Markdown heading titled "## 💡 الملخص (Logline)".`;
                const toneInstruction = `The tone of voice for the output must be: ${tone}.`;
                const dialectInstruction = `All Arabic speech or text must be in the '${dialect}' dialect.`;

                if (format === 'inspiration') {
                    const inspirationToneMap = { 'تسويقية': 'a clever product campaign or a brand story', 'تعليمية': 'a complex topic explained simply or a compelling tutorial idea', 'إبداعية': 'an abstract, artistic, or surreal concept for a short film', 'رسمية': 'a corporate announcement or a professional presentation topic', 'مرحة': 'a funny, relatable situation for a comedy sketch' };
                    return `You are a creative strategist with deep cultural knowledge. Your task is to generate a single, powerful, and authentic video idea. The idea must be culturally relevant to the '${dialect}' Arabic dialect. The required tone of voice is: '${tone}'. Based on this tone, think deeply and provide a one-line concept that is highly suitable for it. For '${tone}', think of ${inspirationToneMap[tone] || 'a creative idea'}. CRITICAL: Your response must be ONLY the idea itself, in Arabic. Do not include any introductory phrases.`;
                }
                if(format === 'chatbot_prompt'){
                    return `You are a world-leading expert in prompt engineering for Large Language Models. Transform the user's simple goal into a comprehensive, structured, and powerful 'mega-prompt' in Arabic. The mega-prompt must define a clear persona, context, goal, constraints, and instructions for the target AI. Persona for AI: '${chatbotRole}'. User's Goal: "${idea}"` + loglineInstruction;
                }
                if (format === 'short_script') {
                    return `أنت كاتب سيناريو عبقري ومُبدع. مهمتك تحويل فكرة بسيطة إلى سكربت قصير (Reel) إبداعي، أصلي، وقوي جداً. ${directorStyle ? `اجعل الروح الفنية للسكربت بأسلوب ${directorStyle}.` : ''} ${toneInstruction} ${dialectInstruction} يجب أن يكون الأسلوب سلس وفيه طابع إنساني يلمس المشاعر. الفكرة: "${idea || 'شخص يكتشف أن ظله له حياة خاصة.'}"` + loglineInstruction;
                }
                if (format === 'youtube_script') {
                    return `أنت كاتب محتوى وخبير يوتيوب عبقري. مهمتك كتابة سكربت فيديو يوتيوب احترافي وشامل يجذب المشاهد. مدة الفيديو المستهدفة هي حوالي ${duration} دقائق. ${toneInstruction} ${dialectInstruction} يجب أن يكون السكربت مقسمًا بوضوح باستخدام Markdown إلى الأقسام التالية: "## 🎬 المقدمة (Hook)", "## 📝 المحتوى الأساسي" (مع عدة نقاط فرعية وقصص وأمثلة), "## ✨ الخاتمة", "## 🗣️ دعوة للعمل (Call to Action)". الموضوع: "${idea || 'كيف تبدأ قناتك على اليوتيوب في 2025'}"` + loglineInstruction;
                }
                if (format === 'veo_prompt' || format === 'script_to_veo') {
                    const instructions = `You are a world-class director AI. Your task is to generate ${sceneCount} separate, complete, and valid JSON prompt objects. Each JSON object must be a standalone prompt for a single scene, but maintain narrative continuity with the previous scene. CRITICAL LANGUAGE PROTOCOL: All values in the JSON must be in ENGLISH, except for the 'dialogue.text' value, which MUST be in ARABIC, in the '${dialect}' dialect. After each complete JSON object, you MUST insert the delimiter \`[JSON_BREAK]\`. Your output must be ONLY the sequence of JSON objects and their delimiters. Ensure all generated content is safe and respectful, adhering to safety policies. The JSON structure for each scene is: {"project_title": "...", "scene_number": ..., "duration_seconds": 8, "visuals": {"style": "...", "environment": "...", "sequence": [{"time": "0-2s", "action": "..."}, ...], "camera": "..."}, "audio": {"sound_design": [{"time": "0-2s", "effect": "..."}], "dialogue": {"text": "...", "language": "Arabic", "dialect": "${dialect}"}}, "advanced_settings": {"quality": "4K", "fps": 30, "color_grading": "..."}}`;
                    let sourceMaterial = format === 'veo_prompt' ? `User's core idea: "${idea || 'A lonely watchmaker.'}"` : `The full Arabic script: --- \\n${script}\\n ---`;
                    return `${instructions}\n\n**Source Material:** ${sourceMaterial}`;
                }
                return '';
            };

            const renderOutput = (data) => {
                $('#output-container').style.display = 'block';
                $('#placeholder').style.display = 'none';
                const outputTabs = $('#outputTabs');
                const outputContent = $('#outputContent');
                outputTabs.innerHTML = '';
                outputContent.innerHTML = '';
                lastGeneratedData = data;

                Object.keys(data).forEach((key, index) => {
                    const tabBtn = document.createElement('button');
                    tabBtn.className = 'tab-btn';
                    tabBtn.dataset.target = `panel-${key}`;
                    tabBtn.textContent = { short_script: 'سكربت قصير', veo_prompt: 'Veo3 (JSON)', youtube_script: 'سكربت يوتيوب', chatbot_prompt: 'برومبت Chatbot' }[key];
                    outputTabs.appendChild(tabBtn);
                    
                    const panel = document.createElement('div');
                    panel.id = `panel-${key}`;
                    panel.className = 'output-panel';
                    
                    if (key === 'veo_prompt' && data[key] && data[key].includes('{')) {
                        const jsonBlocks = data[key].split('[JSON_BREAK]').filter(s => s.trim() !== '');
                        jsonBlocks.forEach((jsonString, i) => {
                            const sceneBlock = document.createElement('div');
                            sceneBlock.className = 'scene-block';
                            let sceneTitle = `مشهد ${i + 1}`;
                            try {
                                const parsedJson = JSON.parse(jsonString);
                                sceneTitle = parsedJson.project_title ? `${parsedJson.project_title} - مشهد ${parsedJson.scene_number || i + 1}` : `مشهد ${parsedJson.scene_number || i + 1}`;
                            } catch (e) {}

                            sceneBlock.innerHTML = `<div class="scene-header"><h2>${sceneTitle}</h2><button class="action-btn toolbar-btn" title="نسخ المشهد" data-action="copy-scene"><i class="fa-regular fa-copy"></i></button></div><div class="scene-content"><pre class="json-output"><code>${highlightJSON(jsonString)}</code></pre></div>`;
                            sceneBlock.querySelector('button[data-action="copy-scene"]').dataset.text = jsonString.trim();
                            panel.appendChild(sceneBlock);
                        });
                    } else if (data[key]) {
                        panel.innerHTML = marked.parse(data[key]);
                    }
                    outputContent.appendChild(panel);
                    
                    if (index === 0) {
                        tabBtn.classList.add('active');
                        panel.classList.add('active');
                    }
                });
                updateMainToolbar(Object.keys(data)[0]);
            };
            
            const updateMainToolbar = (activeTabKey) => {
                const toolbarEl = $('#main-toolbar');
                toolbarEl.innerHTML = '';
                const createBtn = (action, icon, title) => {
                    const btn = document.createElement('button'); btn.className = 'action-btn toolbar-btn'; btn.innerHTML = `<i class="fa-solid ${icon}"></i>`; btn.title = title; btn.dataset.action = action; return btn;
                };
                toolbarEl.appendChild(createBtn('copy-active', 'fa-copy', 'نسخ المحتوى الحالي'));
                toolbarEl.appendChild(createBtn('download-active', 'fa-download', 'تنزيل المحتوى الحالي'));
                toolbarEl.appendChild(createBtn('save', 'fa-save', 'حفظ للمشاريع'));
                if (activeTabKey === 'short_script' && lastGeneratedData.short_script) {
                    toolbarEl.appendChild(createBtn('convert', 'fa-wand-magic-sparkles', 'تحويل لبرومبت Veo3'));
                }
            };
            
            const updateVisibleControls = () => {
                document.querySelectorAll('[data-controls-for]').forEach(el => {
                    const formats = el.dataset.controlsFor.split(' ');
                    el.style.display = formats.includes(currentOutputFormat) ? 'flex' : 'none';
                });
            };

            async function handleGeneration(isGeneratingAll = false, isRandom = false) {
                if (API_KEY === 'YOUR_GEMINI_API_KEY') {
                    showToast('خطأ: مفتاح API غير موجود.', 'error'); return;
                }
                const idea = isRandom ? '' : $('#userInput').value.trim();
                if (!isRandom && idea === '') {
                    toggleModal('confirm-dialog', true); return;
                }
                
                let dialect = $('#dialect-selector').dataset.value;
                if (dialect === 'other') {
                    dialect = $('#custom-dialect-input').value.trim();
                    if(!dialect) {
                        showToast('خطأ: يرجى إدخال اللهجة المخصصة.', 'error'); return;
                    }
                }

                const inputs = {
                    idea: idea,
                    sceneCount: $('#sceneCount').value,
                    directorStyle: $('#director-style').value.trim(),
                    duration: $('#videoDuration').value,
                    tone: $('#tone-of-voice').dataset.value,
                    dialect: dialect,
                    chatbotRole: $('#chatbot-role').dataset.value,
                    script: lastGeneratedData.short_script || ''
                };
                
                showToast('جاري الإنشاء...', 'info', true);
                const mainBtn = isGeneratingAll ? $('#generateAllBtn') : $('#generateBtn');
                toggleButtonLoading(mainBtn, true);
                
                const results = {};
                
                if (isGeneratingAll) {
                    const formats = ['short_script', 'veo_prompt', 'youtube_script', 'chatbot_prompt'];
                    const promises = formats.map(format => performGeneration(buildMasterPrompt({ ...inputs, format })));
                    const [short, veo, youtube, chatbot] = await Promise.all(promises);
                    if (short) results.short_script = short;
                    if (veo) results.veo_prompt = veo;
                    if (youtube) results.youtube_script = youtube;
                    if (chatbot) results.chatbot_prompt = chatbot;
                } else {
                    const result = await performGeneration(buildMasterPrompt({ ...inputs, format: currentOutputFormat }));
                    if (result) results[currentOutputFormat] = result;
                }
                
                toggleButtonLoading(mainBtn, false);

                if (Object.keys(results).length > 0 && Object.values(results).some(v => v)) {
                    showToast('تم الانتهاء بنجاح!', 'success');
                    renderOutput(results);
                } else {
                    showToast('فشل الإنشاء، يرجى المحاولة مرة أخرى.', 'error');
                }
            }
            
            function init() {
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    $('#themeToggleBtn').innerHTML = '<i class="fa-solid fa-sun"></i>';
                } else {
                    $('#themeToggleBtn').innerHTML = '<i class="fa-solid fa-moon"></i>';
                }
                updateVisibleControls();

                $('#generateBtn').addEventListener('click', () => handleGeneration(false, false));
                $('#generateAllBtn').addEventListener('click', () => handleGeneration(true, false));

                $('#confirm-dialog-yes').addEventListener('click', () => {
                    toggleModal('confirm-dialog', false);
                    handleGeneration(false, true);
                });
                $('#confirm-dialog-no').addEventListener('click', () => toggleModal('confirm-dialog', false));
                
                $('#inspiration-btn').addEventListener('click', async () => {
                    const btn = $('#inspiration-btn');
                    toggleButtonLoading(btn, true);
                    let dialect = $('#dialect-selector').dataset.value;
                    if (dialect === 'other') dialect = $('#custom-dialect-input').value.trim() || 'Egyptian';
                    const prompt = buildMasterPrompt({format: 'inspiration', tone: $('#tone-of-voice').dataset.value, dialect: dialect});
                    const idea = await performGeneration(prompt);
                    toggleButtonLoading(btn, false);
                    if (idea) {
                        $('#userInput').value = idea;
                        showToast('تم العثور على فكرة!', 'success');
                    }
                });
                
                $('#themeToggleBtn').addEventListener('click', () => {
                    document.body.classList.toggle('dark-mode');
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    $('#themeToggleBtn').innerHTML = isDarkMode ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
                    localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                });
                
                $('#output-options').addEventListener('click', (e) => {
                    const target = e.target.closest('.sg-btn');
                    if (target && !target.classList.contains('active')) {
                        $('#output-options .sg-btn.active').classList.remove('active');
                        target.classList.add('active');
                        currentOutputFormat = target.dataset.type;
                        updateVisibleControls();
                    }
                });

                $('#model-selector').addEventListener('click', e => {
                    const btn = e.target.closest('.sg-btn');
                    if (!btn || btn.classList.contains('active')) return;
                    $('#model-selector .sg-btn.active').classList.remove('active');
                    btn.classList.add('active');
                    selectedModel = btn.dataset.model;
                    $('#model-helper-text').textContent = selectedModel.includes('pro') ? 'الأقوى والأكثر إبداعًا، قد يكون أبطأ قليلاً.' : 'الأسرع والأكثر كفاءة للأفكار السريعة.';
                });

                document.querySelectorAll('.custom-select').forEach(sel => {
                    const trigger = sel.querySelector('.select-trigger');
                    const optionsList = sel.querySelector('.options');
                    trigger.addEventListener('click', (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('.custom-select.open').forEach(openSel => { if(openSel !== sel) openSel.classList.remove('open'); });
                        sel.classList.toggle('open');
                    });
                    
                    optionsList.addEventListener('click', e => {
                        const opt = e.target.closest('.option-item');
                        if(opt) {
                            const oldValue = sel.querySelector('.option-item.selected');
                            if(oldValue) oldValue.classList.remove('selected');
                            opt.classList.add('selected');
                            sel.querySelector('span').textContent = opt.textContent;
                            sel.dataset.value = opt.dataset.value;
                            sel.classList.remove('open');
                            
                            if(sel.id === 'dialect-selector'){
                                $('#custom-dialect-input').style.display = (opt.dataset.value === 'other') ? 'block' : 'none';
                            }
                        }
                    });
                });
                document.addEventListener('click', () => document.querySelectorAll('.custom-select.open').forEach(sel => sel.classList.remove('open')));

                $('#main-toolbar').addEventListener('click', async (e) => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;
                    const action = button.dataset.action;
                    const activePanel = $('#outputContent .output-panel.active');
                    const activeKey = activePanel ? activePanel.id.replace('panel-', '') : null;
                    const contentToUse = activeKey ? lastGeneratedData[activeKey] : null;

                    if (action === 'copy-active') copyToClipboard(contentToUse, button);
                    else if (action === 'download-active') downloadContent(contentToUse, `PromptsMeDoX-${activeKey}.md`);
                    else if (action === 'save') {
                        if (Object.keys(lastGeneratedData).length === 0) { showToast('لا يوجد محتوى لحفظه!', 'error'); return; }
                        let dialect = $('#dialect-selector').dataset.value;
                        if (dialect === 'other') dialect = $('#custom-dialect-input').value.trim();
                        const project = { id: Date.now(), idea: $('#userInput').value, settings: { scenes: $('#sceneCount').value, style: $('#director-style').value, duration: $('#videoDuration').value, tone: $('#tone-of-voice').dataset.value, dialect: dialect, chatbotRole: $('#chatbot-role').dataset.value }, outputs: lastGeneratedData, date: new Date().toLocaleString('ar-EG') };
                        const projects = JSON.parse(localStorage.getItem(PROJECTS_STORAGE_KEY) || '[]');
                        projects.unshift(project);
                        localStorage.setItem(PROJECTS_STORAGE_KEY, JSON.stringify(projects));
                        showToast('تم حفظ المشروع بنجاح!', 'success');
                    } else if (action === 'convert') {
                        if (!lastGeneratedData.short_script || isGenerating) return;
                        showToast('جاري التحويل...', 'info', true);
                        let dialect = $('#dialect-selector').dataset.value;
                        if (dialect === 'other') dialect = $('#custom-dialect-input').value.trim();
                        const inputs = { idea: $('#userInput').value.trim(), sceneCount: $('#sceneCount').value, directorStyle: $('#director-style').value.trim(), tone: $('#tone-of-voice').dataset.value, dialect: dialect, script: lastGeneratedData.short_script };
                        const result = await performGeneration(buildMasterPrompt({ ...inputs, format: 'script_to_veo' }));
                        
                        if(result){
                            lastGeneratedData.veo_prompt = result;
                            renderOutput(lastGeneratedData);
                            const veoTab = $('#outputTabs .tab-btn[data-target="panel-veo_prompt"]');
                            if(veoTab) veoTab.click();
                            showToast('تم التحويل بنجاح!', 'success');
                        }
                    }
                });

                $('#outputTabs').addEventListener('click', (e) => {
                    const tabBtn = e.target.closest('.tab-btn');
                    if (!tabBtn || tabBtn.classList.contains('active')) return;
                    const currentActiveTab = $('#outputTabs .tab-btn.active');
                    if(currentActiveTab) currentActiveTab.classList.remove('active');
                    const currentActivePanel = $('#outputContent .output-panel.active');
                    if(currentActivePanel) currentActivePanel.classList.remove('active');
                    
                    tabBtn.classList.add('active');
                    const targetPanel = $(`#${tabBtn.dataset.target}`);
                    if (targetPanel) targetPanel.classList.add('active');
                    updateMainToolbar(tabBtn.dataset.target.replace('panel-', ''));
                });
                
                $('#outputContent').addEventListener('click', e => {
                    const button = e.target.closest('button[data-action="copy-scene"]');
                    if (button) copyToClipboard(button.dataset.text, button);
                });
                
                $('#my-projects-btn').addEventListener('click', () => {
                    const projectsList = $('#projects-list');
                    if(!projectsList) return;
                    projectsList.innerHTML = '';
                    const projects = JSON.parse(localStorage.getItem(PROJECTS_STORAGE_KEY) || '[]');
                    if (projects.length === 0) {
                        projectsList.innerHTML = '<li style="text-align:center; opacity:0.7;">لا توجد مشاريع محفوظة.</li>';
                    } else {
                        projects.forEach(p => {
                            const li = document.createElement('li');
                            li.className = 'project-item';
                            li.dataset.projectId = p.id;
                            li.innerHTML = `<div class="project-item-info"><strong>${(p.idea || 'مشروع بدون عنوان').substring(0, 40)}...</strong><span style="font-size:0.9rem;opacity:0.7;">${p.date}</span></div>`;
                            projectsList.appendChild(li);
                        });
                    }
                    toggleModal('projects-modal', true);
                });
                
                $('#projects-list').addEventListener('click', e => {
                    const item = e.target.closest('.project-item');
                    if (!item) return;
                    const projectId = parseInt(item.dataset.projectId);
                    const projects = JSON.parse(localStorage.getItem(PROJECTS_STORAGE_KEY) || '[]');
                    const project = projects.find(p => p.id === projectId);
                    if(project) {
                        $('#preview-title').textContent = project.idea || 'معاينة المشروع';
                        const previewToolbar = $('#preview-toolbar');
                        previewToolbar.innerHTML = '';
                        const previewContent = $('#preview-content');
                        previewContent.innerHTML = '';
                        const allContent = Object.values(project.outputs).join('\n\n---\n\n');
                        
                        Object.keys(project.outputs).forEach(key => {
                            const title = document.createElement('h2');
                            title.textContent = { short_script: 'سكربت قصير', veo_prompt: 'Veo3 (JSON)', youtube_script: 'سكربت يوتيوب', chatbot_prompt: 'برومبت Chatbot' }[key];
                            title.style.cssText = 'font-size:1.5rem;color:var(--primary-color);border-bottom:2px solid var(--border-color);padding-bottom:0.5rem;margin:1.5rem 0 1rem 0;';
                            previewContent.appendChild(title);
                            if (key === 'veo_prompt' && project.outputs[key].includes('{')) {
                                project.outputs[key].split('[JSON_BREAK]').filter(s => s.trim() !== '').forEach((jsonString, i) => {
                                    const sceneBlock = document.createElement('div'); sceneBlock.className = 'scene-block';
                                    let sceneTitle = `مشهد ${i + 1}`; try { const p = JSON.parse(jsonString); sceneTitle = p.project_title ? `${p.project_title} - م ${p.scene_number || i + 1}` : `مشهد ${p.scene_number || i + 1}`} catch(e){}
                                    sceneBlock.innerHTML = `<div class="scene-header"><h2>${sceneTitle}</h2><button class="action-btn toolbar-btn" title="نسخ المشهد" data-action="copy-scene"><i class="fa-regular fa-copy"></i></button></div><div class="scene-content"><pre class="json-output"><code>${highlightJSON(jsonString)}</code></pre></div>`;
                                    sceneBlock.querySelector('button[data-action="copy-scene"]').dataset.text = jsonString.trim();
                                    previewContent.appendChild(sceneBlock);
                                });
                            } else {
                                const contentDiv = document.createElement('div');
                                contentDiv.innerHTML = marked.parse(project.outputs[key]);
                                previewContent.appendChild(contentDiv);
                            }
                        });

                        const createBtn = (action, icon, title, clickHandler) => { const b=document.createElement('button'); b.className='action-btn toolbar-btn'; b.title=title; b.innerHTML=`<i class="fa-solid ${icon}"></i>`; b.onclick=clickHandler; return b; };
                        previewToolbar.appendChild(createBtn('copy-all', 'fa-copy', 'نسخ الكل', (e) => copyToClipboard(allContent, e.currentTarget)));
                        previewToolbar.appendChild(createBtn('download', 'fa-download', 'تنزيل', () => downloadContent(allContent, `Project-${project.id}.md`)));
                        $('#load-from-preview-btn').dataset.projectId = project.id;
                        toggleModal('preview-modal', true);
                    }
                });

                $('#preview-content').addEventListener('click', e => {
                    const button = e.target.closest('button[data-action="copy-scene"]');
                    if (button) copyToClipboard(button.dataset.text, button);
                });

                $('#load-from-preview-btn').addEventListener('click', e => {
                    const projectId = parseInt(e.target.dataset.projectId);
                    const projects = JSON.parse(localStorage.getItem(PROJECTS_STORAGE_KEY) || '[]');
                    const p = projects.find(proj => proj.id === projectId);
                    if(p) {
                        $('#userInput').value = p.idea;
                        const settings = p.settings || {};
                        $('#sceneCount').value = settings.scenes || 3;
                        $('#director-style').value = settings.style || '';
                        $('#videoDuration').value = settings.duration || 5;
                        
                        document.querySelectorAll('.custom-select').forEach(sel => {
                            const selId = sel.id.replace('-selector', '').replace('-', '_');
                            const value = settings[selId] || sel.querySelector('.option-item').dataset.value;
                            const item = sel.querySelector(`.option-item[data-value="${value}"]`);
                            const customInput = $('#custom-dialect-input');
                            if(item) {
                                sel.querySelector('.option-item.selected')?.classList.remove('selected');
                                item.classList.add('selected');
                                sel.querySelector('span').textContent = item.textContent;
                                sel.dataset.value = item.dataset.value;
                                if(sel.id === 'dialect-selector') {
                                    customInput.style.display = 'none';
                                }
                            } else if (sel.id === 'dialect-selector') {
                                const otherOpt = sel.querySelector('.option-item[data-value="other"]');
                                if(otherOpt){
                                    otherOpt.classList.add('selected');
                                    sel.querySelector('span').textContent = otherOpt.textContent;
                                    sel.dataset.value = 'other';
                                    customInput.value = settings.dialect;
                                    customInput.style.display = 'block';
                                }
                            }
                        });
                        
                        renderOutput(p.outputs);
                        toggleModal('preview-modal', false);
                        toggleModal('projects-modal', false);
                    }
                });
                
                document.querySelectorAll('[data-action="close-modal"]').forEach(btn => {
                    btn.addEventListener('click', () => toggleModal(btn.dataset.target, false))
                });

                window.addEventListener('online', () => showToast('تم استعادة الاتصال بالإنترنت!', 'success'));
                window.addEventListener('offline', () => showToast('لقد فقدت الاتصال بالإنترنت.', 'error'));
            }
            init();
        });
    } catch(e) {
        document.body.innerHTML = `<div style="font-family: sans-serif; text-align: center; padding: 2rem; color: #dc3545;"><h1>حدث خطأ فادح</h1><p>لم يتمكن التطبيق من العمل.</p><p style="font-size: 0.8rem; color: #6c757d;">${e.message}</p></div>`;
    }
    </script>
</body>
</html>
